# winevdm for Win64

— Run apps for 16-bit Windows (Windows 1.x, 2.x, 3.0, 3.1, etc.) on 64-bit Windows —

This is an altered version of winevdm (a 16-bit Windows emulator for the [wine project](www.winehq.org)), ported to 64-bit Windows.

![CALC.EXE for Windows 1.0 running on Windows 10](screenshot.PNG)

It can also run DOS executables (DOS emulator-like), but DOS support is limited. You can set the DOS version with the VDMDOSVER environment variable.

---

# How to use it?

## 1. Download

[Download latest version (unstable)](https://ci.appveyor.com/project/otya128/winevdm/)

1. Go to one of the two environments (`THIS_BUILD_IS_RECOMMENDED_...` or `THIS_BUILD_IS_NOT_RECOMMENDED_...`).
2. Select the `Artifacts` tab.
3. Download the zip archive.

[Download stable version (outdated!)](https://github.com/otya128/winevdm/releases)

## 2. Try it (recommended before installation!)

1. Unpack the downloaded zip archive to a safe place that doesn't require admin privileges.
2. Drag and drop the Win16 executable file to **`otvdm.exe`** or execute **`otvdmw.exe`** and choose the Win16 executable.
    + If you get an error that **`VCRUNTIME140.dll`** is missing, install [Microsoft Visual C++ Redistributable for Visual Studio 2017 (32-bit)](https://aka.ms/vs/15/release/vc_redist.x86.exe).

## 3. How to install

### Some background first:

> What is 'installing winevdm'?
>
> When 64-bit Windows detects a 16-bit installer, it has a mechanism to start a 32-bit replacement installer.
>
> Installing **`install(w).inf`** **modifies the Windows registry** to hijack this mechanism so that when you try to start any 16-bit executable, instead winevdm is started runnning the 16-bit executable. This does not work for Windows 1.0 or DOS executables.

> **General note:** It does not harm to know admin essentials like e.g. how to work with a command prompt, a bit of *batch*, how the Windows registry works etc. before messing with system internals like smuggling in a 16-bit Windows layer.

### Installing winevdm:

1. Download (see above) or compile (build instructions [here](#How-to-compile)).
2. Put (unpack, move) winevdm to a top-level directory, e.g. `C:\winevdm\%version-dir%`.
3. Install (requires admin privileges):
    + Launch `install` to see the otvdm console window every time a 16-bit executable is run (installs `install.inf`).
    + Launch `install (no console)` for the otvdm console window to stay hidden (installs `installw.inf`).
4. You can run Win16 executables directly!

> **Note:** If you install v0.4.x, you should replace [Strings] section of `install.inf` and `installw.inf` with these and install again:
> ```ini
> [Strings]
> NtVdm64=SOFTWARE\Microsoft\Windows NT\CurrentVersion\NtVdm64
> CommandLine="""%m"" %c"
> MappedExeName=otvdm.exe
> ```

### Customizing winevdm

// TODO: Document otvdm.ini (probably in separate file)

## Reporting issues:

When you report an issue, we will likely ask you to create a *"trace"* to analyze what went wrong:

1. Open a command prompt, navigate to a directory to which you want the trace to be written.
2. Set the `WINEDEBUG` environment variable:
   ```cmd
   set WINEDEBUG=+all,-snoop,-ldt,-fixup,-module,-global,-local,-disasm,-syslevel,-thunk
   ```
3. Run the 16-bit executable with standard error stream redirected to the file `trace.txt`:
   ```cmd
   %path-to-old-executable-file% 2> trace.txt
   ```
   Or in case you have not installed yet:
   ```cmd
   %path-to-otvdm.exe% %path-to-old-executable-file% 2> trace.txt
   ```
4. Upload the trace file to the GitHub issue.
   <!-- > **Note:** If you think the trace might contain sensitive information ... -->

---

# How does winevdm work?

This program contains the following items:

+ CPU Emulator
    + 64-bit Windows cannot modify LDT (NtSetInformationProcess(,ProcessLdtInformation,,) always returns error)
+ wine based Win16&rarr;Win32 conversion codes:
  ```c
  BOOL16 WINAPI DestroyWindow16( HWND16 hwnd )
  {
      return DestroyWindow( WIN_Handle32(hwnd) );
  }
  ```
  These relay routines from 16-bit to 32-bit are autogenerated by convspec:
  ```spec
  53  pascal -ret16 DestroyWindow(word) DestroyWindow16
  ```
+ 16-bit &harr; native HANDLE conversion
+ DOS emulation for Win16
+ Fix compatibility problems, fix compatibility problems

## `Windows` directory redirection

Some Win16 programs try to save their settings in `%WINDIR%\<appname>.ini`.

In recent Windows versions, saving to `%WINDIR%` is forbidden, so winevdm redirects this path to a custom directory.

## Registry redirection

// TODO: Document possible implications (e.g. OLE)

# winevdm
```bat
winevdm.exe [--app-name app.exe] command line
winevdm.exe CALC.EXE
```

# How to compile

## Visual Studio

+ Install Visual Studio 2017
+ Edit PropertySheet.props
+ Compile

## CMake

```sh
git clone https://github.com/otya128/winevdm.git
cd winevdm
mkdir build
cd build
cmake ..
make
```
